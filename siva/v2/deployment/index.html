<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="no-js ie6"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8"><![endif]-->
<!--[if IE 9 ]><html class="no-js ie9"><![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    
      
        <title>Deployment - SiVa - Validation Service Documentation</title>
      
      
      
      
    
    <meta property="og:url" content="None">
    <meta property="og:title" content="SiVa - Validation Service Documentation">
    <meta property="og:image" content="None/../../../">
    <meta name="apple-mobile-web-app-title" content="SiVa - Validation Service Documentation">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    
    <link rel="shortcut icon" type="image/x-icon" href="../../../None">
    <link rel="icon" type="image/x-icon" href="../../../None">
    <style>
      @font-face {
      	font-family: 'Icon';
      	src: url('../../../assets/fonts/icon.eot?52m981');
      	src: url('../../../assets/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
      		   url('../../../assets/fonts/icon.woff?52m981')
               format('woff'),
      		   url('../../../assets/fonts/icon.ttf?52m981')
               format('truetype'),
      		   url('../../../assets/fonts/icon.svg?52m981#icon')
               format('svg');
      	font-weight: normal;
      	font-style: normal;
      }
    </style>
    <link rel="stylesheet" href="../../../assets/stylesheets/application-0dac3e5884.css">
    
      <link rel="stylesheet" href="../../../assets/stylesheets/palettes-05ab2406df.css">
    
    
      
      
      
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Roboto+Mono">
      <style>
        body, input {
          font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
        }
        pre, code {
          font-family: 'Roboto Mono', 'Courier New', 'Courier', monospace;
        }
      </style>
    
    
      <link rel="stylesheet" href="../../../override.css">
    
    <script src="../../../assets/javascripts/modernizr-4ab42b99fd.js"></script>
    
  </head>
  
  
  
  <body class="palette-primary-cyan palette-accent-light-blue">
    
      
      
    
    <div class="backdrop">
      <div class="backdrop-paper"></div>
    </div>
    <input class="toggle" type="checkbox" id="toggle-drawer">
    <input class="toggle" type="checkbox" id="toggle-search">
    <label class="toggle-button overlay" for="toggle-drawer"></label>
    <header class="header">
      <nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        
          <span class="path">
            
          </span>
        
        Deployment
      </div>
    </div>
    
    
    <div class="button button-search" role="button" aria-label="Search">
      <label class="toggle-button icon icon-search" title="Search" for="toggle-search"></label>
    </div>
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
    </header>
    <main class="main">
      
      <div class="drawer">
        <nav aria-label="Navigation">
  
  <a href="https://github.com/open-eid/SiVa" class="project">
    <div class="banner">
      
      <div class="name">
        <strong>
          SiVa - Validation Service Documentation
          <span class="version">
            
          </span>
        </strong>
        
          <br>
          open-eid/SiVa
        
      </div>
    </div>
  </a>
  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            
            <a href="https://github.com/open-eid/SiVa/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/open-eid/SiVa/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      
      <div class="toc">
        <ul>
          
            
  <li>
    <a class="" title="Introduction" href="../../..">
      Introduction
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Version info" href="../../version_info/">
      Version info
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Definitions" href="../../definitions/">
      Definitions
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="SiVa Service Overview" href="../../overview/">
      SiVa Service Overview
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Structure and activities" href="../structure_and_activities/">
      Structure and activities
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Interfaces" href="../interfaces/">
      Interfaces
    </a>
    
  </li>

          
            
  <li>
    <a class="current" title="Deployment" href="./">
      Deployment
    </a>
    
      
      
        <ul>
          
            <li class="anchor">
              <a title="Deployment diagram" href="#deployment-diagram">
                Deployment diagram
              </a>
            </li>
          
            <li class="anchor">
              <a title="SiVa System deployment" href="#siva-system-deployment">
                SiVa System deployment
              </a>
            </li>
          
        </ul>
      
    
  </li>

          
            
  <li>
    <a class="" title="Quality Assurance Strategy" href="../../qa_strategy/">
      Quality Assurance Strategy
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Test Plan" href="../../test_plan/">
      Test Plan
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="References" href="../../references/">
      References
    </a>
    
  </li>

          
            
  <li>
    <span class="section">Appendixes</span>
    <ul>
      
        
  <li>
    <a class="" title="Appendix 1 - Validation Policy" href="../../appendix/validation_policy/">
      Appendix 1 - Validation Policy
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Appendix 2 - Validation Constraint Configuration" href="../../appendix/validation_constraints/">
      Appendix 2 - Validation Constraint Configuration
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Appendix 3 - Test Case Descriptions" href="../../appendix/test_cases/">
      Appendix 3 - Test Case Descriptions
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Appendix 4 - WSDL of SOAP Interface" href="../../appendix/wsdl/">
      Appendix 4 - WSDL of SOAP Interface
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Appendix 5 - Known Issues" href="../../appendix/known_issues/">
      Appendix 5 - Known Issues
    </a>
    
  </li>

      
    </ul>
  </li>

          
        </ul>
        
      </div>
    </div>
  </div>
</nav>
      </div>
      <article class="article">
        <div class="wrapper">
          
            <h1>Deployment</h1>
          
          <h2 id="deployment-diagram">Deployment diagram</h2>
<p><img alt="SiVa Deployment view" src="../../../img/siva/uml_siva_deployment_diagram.png" /></p>
<h3 id="load-balancer">Load balancer</h3>
<p>Load balancer can distribute traffic between SiVa nodes when there is more then one instance running.
SiVa do not set any specific requirements for load balancer but in diagram the Nginx reverse proxy option is used.</p>
<h3 id="siva-web-application">SiVa web application</h3>
<p>SiVa web appliction is executable Spring Boot JAR file. This means all the dependencies and servlet containers are
packaged inside single JAR file. The JAR file can be placed anywhere in server and the JAR must be marked executable
if its not already.</p>
<p>There also should be separate user created to run executalbe JAR as Linux service.</p>
<p>Read more about running
<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/deployment-install.html#deployment-service">Spring Boot applications as Linux system service</a></p>
<h3 id="siva-x-road-validation-service">SiVa X-Road validation service</h3>
<p>SiVa X-Road validation service is also Spring Boot executable JAR application and also should be installed as Linux
service. X-Road validation service communicates with SiVa web application over HTTP and default port is 8081</p>
<p>X-Road separate installation is required to avoid BouncyCastle libraries version conflicts and class loader
issues.</p>
<h3 id="security-server">Security server</h3>
<p>Into XRoad v6 security server the SiVa validation service will be registered to provide service to other organisations
using XRoad infrastructure. Setting up XRoad Security server is out of scope for SiVa documentaiton.</p>
<h2 id="siva-system-deployment">SiVa System deployment</h2>
<h3 id="system-requirements">System requirements</h3>
<p>Following are minimum requirements to build and deploy SiVa validation
web service:</p>
<ul>
<li>Java 8 or above Oracle JVM is supported</li>
<li>Git version control system version 1.8 or above is recommended</li>
<li>Minimum 2 GB of RAM. Recommended at least 4 GB of RAM</li>
<li>Minimum 1 processor core</li>
<li>Open internet connection</li>
<li>1GB of free disk space</li>
<li>Supported operating system is Ubuntu 14.04 LTS</li>
</ul>
<h3 id="building-siva-validation-web-service-on-ubuntu-1604">Building SiVa validation web service on Ubuntu 16.04</h3>
<p>First we need to install Git and Java SDK 8 by issuing below commands:</p>
<pre class="codehilite"><code class="language-bash">sudo apt-get update
sudo apt-get install git -y
sudo apt-get install default-jdk -y</code></pre>


<p>Next we need to clone the SiVa Github repository:</p>
<pre class="codehilite"><code class="language-bash">git clone https://github.com/open-eid/SiVa.git --branch develop</code></pre>


<p>Final step is building the SiVa project using Maven Wrapper</p>
<pre class="codehilite"><code class="language-bash">cd SiVa
./mvnw install</code></pre>


<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The build can take up to <strong>30 minutes</strong> because there are lot of tests that will be run through and downloading of the
required dependencies</p>
</div>
<p>To verify that SiVa project built successfully look for <code>BUILD SUCCESS</code> in build compilation output last lines.
The last lines of build output should look very similar to below image:</p>
<pre class="codehilite"><code class="language-text">[INFO] Reactor Summary:
[INFO]
[INFO] SiVa Digitally signed documents validation service . SUCCESS [ 25.258 s]
[INFO] validation-services-parent ......................... SUCCESS [  0.479 s]
[INFO] validation-commons ................................. SUCCESS [01:45 min]
[INFO] tsl-loader ......................................... SUCCESS [ 16.507 s]
[INFO] PDF Validation Service ............................. SUCCESS [ 42.263 s]
[INFO] BDOC Validation Service ............................ SUCCESS [ 58.864 s]
[INFO] DDOC Validation Service ............................ SUCCESS [  9.929 s]
[INFO] xroad-validation-service ........................... SUCCESS [  5.664 s]
[INFO] SIVa webapp and other core modules ................. SUCCESS [  0.315 s]
[INFO] SiVa validation service proxy ...................... SUCCESS [ 43.098 s]
[INFO] siva-webapp ........................................ SUCCESS [04:06 min]
[INFO] SiVa Sample Web application ........................ SUCCESS [04:31 min]
[INFO] SiVa Web Service integration tests ................. SUCCESS [03:41 min]
[INFO] siva-distribution .................................. SUCCESS [ 56.941 s]
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 18:30 min
[INFO] Finished at: 2016-07-22T13:40:31+00:00
[INFO] Final Memory: 80M/250M
[INFO] ------------------------------------------------------------------------</code></pre>


<h3 id="setting-up-systemd-service">Setting up systemd service</h3>
<p>Maven build generates executable JAR files. This means web container and all its dependencies are package inside
single JAR file. It makes a lot easier to deploy it into servers.</p>
<p>Easiest option to setup SiVa is as <code>systemd</code> service in Ubuntu servers.</p>
<p>For that we first need to create service file:</p>
<pre class="codehilite"><code class="language-bash">vim siva-webapp.service</code></pre>


<p>Inside it we need to paste below text. You need and can change few things in service setup file.</p>
<ul>
<li>First you <strong>must not</strong> run service as <code>root</code>. So it's strongly recommended to change line <code>User=root</code></li>
<li>Second You can change Java JVM options by modifying the <code>JAVA_OPTS</code> inside the <code>siva-webapp.service</code> file.</li>
<li>Also You can change the SiVa application configuration options by modifying <code>RUN_ARGS</code> section in file</li>
</ul>
<pre class="codehilite"><code class="language-ini">[Unit]
Description=siva-webapp
After=syslog.target

[Service]
User=root
ExecStart=/var/apps/siva-webapp.jar
Environment=JAVA_OPTS=-Xmx320m RUN_ARGS=--server.port=80
SuccessExitStatus=143

[Install]
WantedBy=multi-user.target</code></pre>


<p>Save and close the <code>siva-webapp.service</code> file.
Next we need to move <code>siva-webapp-2.0.2-SNAPSHOT.jar</code> into newly created <code>/var/apps</code> directory and rename to
JAR file to <code>siva-webapp.jar</code>. match</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The copied JAR filename must match option <code>ExecStart</code> in  <code>siva-webaapp.servcie</code> file</p>
</div>
<pre class="codehilite"><code class="language-bash">sudo mkdir /var/apps
sudo cp siva-parent/siva-webapp/target/executable/siva-webapp-2.0.2-SNAPSHOT.jar /var/apps/siva-webapp.jar</code></pre>


<p>Next we need to copy the <code>siva-webapp.service</code> file into <code>/lib/systemd/system</code> directory.
Then we are ready to start the <code>siva-webapp</code> service.</p>
<pre class="codehilite"><code class="language-bash">sudo cp siva-webapp.service /lib/systemd/system
sudo systemctl start siva-webapp</code></pre>


<p>Final step of setting up the <code>siva-webapp</code> service is to verify that service started correctly by issuing below
command.</p>
<pre class="codehilite"><code class="language-bash">systemctl status siva-webapp</code></pre>


<p>It should print out similar to below picture:</p>
<pre class="codehilite"><code>● siva-webapp.service - siva-webapp
   Loaded: loaded (/lib/systemd/system/siva-webapp.service; disabled; vendor preset: enabled)
   Active: active (running) since Thu 2016-07-21 08:48:14 EDT; 1 day 2h ago
 Main PID: 15965 (siva-webapp.jar)
    Tasks: 34
   Memory: 429.6M
      CPU: 2min 5.721s
   CGroup: /system.slice/siva-webapp.service
           ├─15965 /bin/bash /var/apps/stage/siva-webapp.jar
           └─15982 /usr/bin/java -Dsun.misc.URLClassPath.disableJarChecking=true -Xmx320m -jar /var/apps/stage/siva-webapp.jar

Jul 20 03:00:01 siva siva-webapp.jar[15965]:         at eu.europa.esig.dss.tsl.service.TSLParser.getTslModel(TSLParser.java:143)
Jul 20 03:00:01 siva siva-webapp.jar[15965]:         at eu.europa.esig.dss.tsl.service.TSLParser.call(TSLParser.java:129)
Jul 20 03:00:01 siva siva-webapp.jar[15965]:         ... 5 common frames omitted
Jul 20 03:00:01 siva siva-webapp.jar[15965]: 20.07.2016 03:00:01.450 INFO  [pool-3-thread-1] [e.e.e.dss.tsl.service.TSLRepository.sync
Jul 20 03:00:01 siva siva-webapp.jar[15965]: 20.07.2016 03:00:01.450 INFO  [pool-3-thread-1] [e.e.e.dss.tsl.service.TSLRepository.sync</code></pre>


<h3 id="installing-httpie">Installing HTTPIE</h3>
<p><code>httpie</code> is more user friendly version of <code>curl</code> and we will use to verify that SiVa was installed
and started correctly on our server.</p>
<h3 id="ubuntu-1604">Ubuntu 16.04</h3>
<p>On Ubuntu You can install it using <code>apt</code> package manager:</p>
<pre class="codehilite"><code class="language-bash">sudo apt-get install -y httpie</code></pre>


<h3 id="mac-os-x">Mac OS X</h3>
<p>On Mac it's strongly recommended to install it using package manager like Homebrew by issuing
belwo command:</p>
<pre class="codehilite"><code class="language-bash">brew install httpie</code></pre>


<h4 id="windows">Windows</h4>
<p>On Windows there is no prebuilt package that can be installed but <code>httpie</code> installation instruction in
<a href="http://www.hanselman.com/blog/InstallingHTTPIEHTTPForHumansOnWindowsGreatForASPNETWebAPIAndRESTfulJSONServices.aspx">Scott Hanselmans blog post</a></p>
<h3 id="cross-platform">Cross platform</h3>
<p>Alternative option if You have Python and its package manager <code>pip</code> installed. Then You can issue
below command:</p>
<pre class="codehilite"><code class="language-bash">pip install httpie</code></pre>


<h3 id="verify-digitally-signed-file">Verify digitally signed file</h3>
<p>After You have successfully installed HTTPIE. Then we need to download sample JSON request file with below
command</p>
<pre class="codehilite"><code class="language-bash">http --download https://raw.githubusercontent.com/open-eid/SiVa/develop/build-helpers/bdoc_pass.json</code></pre>


<p>After successful download issue below command in same directory where You downloaded the file using
the above command.</p>
<pre class="codehilite"><code class="language-bash">http POST http://10.211.55.9:8080/validate &lt; bdoc_pass.json</code></pre>


<p>Output of this command should look like below screenshot. Look for <code>signatureCount</code> and
<code>validSignatureCount</code> they <strong>must</strong> be equal.</p>
<p><img alt="HTTPIE output validation" src="../../../img/siva/siva-output.png" /></p>
<h3 id="siva-configuration-overrides">SiVa configuration overrides</h3>
<p>All override configuration properties</p>
<pre class="codehilite"><code class="language-properties"># BDOC validation service override properties
siva.bdoc.digidoc4JConfigurationFile=/path/to/digidoc4j.yml
siva.bdoc.signaturePolicy.defaultPolicy=policy_name
siva.bdoc.signaturePolicy.policies.pol_v1=/path/to/policy1.xml
siva.bdoc.signaturePolicy.policies.pol_v2=/path/to/policy2.xml

# DDOC validation service override properties
siva.ddoc.jdigidocConfigurationFile=/path/to/jdigidoc.cfg
siva.ddoc.signaturePolicy.defaultPolicy=policy_name
siva.ddoc.signaturePolicy.policies.pol_v1=/path/to/policy1.xml
siva.ddoc.signaturePolicy.policies.pol_v2=/path/to/policy2.xml

# PadES validation service override properties
siva.pdf.signaturePolicy.defaultPolicy=policy_name
siva.pdf.signaturePolicy.policies.pol_v1=/path/to/policy1.xml
siva.pdf.signaturePolicy.policies.pol_v2=/path/to/policy2.xml

# X-road validation service settings
siva.xroad.validation.service.configurationDirectoryPath=''
siva.xroad.signaturePolicy.defaultPolicy=policy_name
siva.xroad.signaturePolicy.policies.pol_v1=/path/to/policy1.xml
siva.xroad.signaturePolicy.policies.pol_v2=/path/to/policy2.xml

# TSL trusted certificaes keystore settings
siva.keystore.type=JKS
siva.keystore.filename=/path/to/siva-keystore.jks
siva.keystore.password=siva-keystore-password

# SiVa Proxy Settings
siva.proxy.xroadUrl=http://localhost:8081

siva.statistics.google-analytics.url=http://www.google-analytics.com/batch
siva.statistics.google-analytics.trackingId=UA-83206619-1
siva.statistics.google-analytics.dataSourceName=SiVa

siva.tsl.loader.loadFromCache=false
siva.tsl.loader.url=https://ec.europa.eu/information_society/policy/esignature/trusted-list/tl-mp.xml
siva.tsl.loader.code=EU
siva.tsl.loader.schedulerCron=0 0 3 * * ?</code></pre>
          <aside class="copyright" role="note">
            
            Documentation built with
            <a href="http://www.mkdocs.org" target="_blank">MkDocs</a>
            using the
            <a href="http://squidfunk.github.io/mkdocs-material/" target="_blank">
              Material
            </a>
            theme.
          </aside>
          
            <footer class="footer">
              
  <nav class="pagination" aria-label="Footer">
    <div class="previous">
      
        <a href="../interfaces/" title="Interfaces">
          <span class="direction">
            Previous
          </span>
          <div class="page">
            <div class="button button-previous" role="button" aria-label="Previous">
              <i class="icon icon-back"></i>
            </div>
            <div class="stretch">
              <div class="title">
                Interfaces
              </div>
            </div>
          </div>
        </a>
      
    </div>
    <div class="next">
      
        <a href="../../qa_strategy/" title="Quality Assurance Strategy">
          <span class="direction">
            Next
          </span>
          <div class="page">
            <div class="stretch">
              <div class="title">
                Quality Assurance Strategy
              </div>
            </div>
            <div class="button button-next" role="button" aria-label="Next">
              <i class="icon icon-forward"></i>
            </div>
          </div>
        </a>
      
    </div>
  </nav>

            </footer>
          
        </div>
      </article>
      <div class="results" role="status" aria-live="polite">
        <div class="scrollable">
          <div class="wrapper">
            <div class="meta"></div>
            <div class="list"></div>
          </div>
        </div>
      </div>
    </main>
    <script>
      var base_url = '../../..';
      var repo_id  = 'open-eid/SiVa';
    </script>
    <script src="../../../assets/javascripts/application-997097ee0c.js"></script>
    
    
  </body>
</html>